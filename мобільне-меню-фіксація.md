# Аналіз фіксації мобільного меню

## Огляд архітектури

Мобільне меню використовує комбінацію CSS `position: sticky` для основного контейнера та `position: fixed` для overlay/dropdown, разом з JavaScript логікою для блокування скролу body при відкритті меню.

## 1. HTML структура

### Основна структура мобільного меню

```402:432:templates/main/home.html
<div class="mobile-nav-container">
  <header class="header" id="header">
    <nav class="header__nav">
      <ul class="header__menu">
        <!-- пункти меню -->
      </ul>
    </nav>
  </header>
  
  <button class="burger-menu" 
          data-burger-toggle 
          aria-label="Відкрити меню" 
          aria-expanded="false">
    <span class="burger-menu__icon">
      <span class="burger-menu__line"></span>
      <span class="burger-menu__line"></span>
      <span class="burger-menu__line"></span>
    </span>
  </button>
</div>
```

### Overlay та dropdown меню

```434:444:templates/main/home.html
<div class="burger-menu__overlay" data-burger-overlay aria-hidden="true"></div>

<nav class="burger-menu__dropdown" data-burger-menu aria-hidden="true">
  <ul class="burger-menu__list">
    <!-- пункти dropdown меню -->
  </ul>
</nav>
```

## 2. CSS фіксація основного контейнера

### Ключові стилі для фіксації

**Мобільний контейнер з sticky позиціонуванням:**

```17:48:static/css/header.css
@media (width <= 767px) {
  .mobile-nav-container {
    display: grid !important;
    grid-template-columns: 1fr auto;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    
    /* Sticky позиціонування */
    position: sticky;
    position: sticky;
    bottom: 10px;
    bottom: max(10px, env(safe-area-inset-bottom, 10px));
    z-index: 1001;
    
    /* Ширина з урахуванням safe-area */
    width: 100%;
    max-width: 100vw;
    box-sizing: border-box;
    
    /* Padding з iOS safe area */
    padding-left: max(10px, env(safe-area-inset-left, 10px));
    padding-right: max(10px, env(safe-area-inset-right, 10px));
    padding-top: 0;
    padding-bottom: 0;
    
    /* iOS Safari fix: hardware acceleration */
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
  }
}
```

**Важливо:** Використовується `position: sticky` замість `position: fixed` для iOS Safari сумісності.

### Header всередині контейнера

```393:420:static/css/header.css
@media (width <= 767px) {
  .header {
    position: static;
    bottom: auto;
    left: auto;
    right: auto;
    width: 100%;
    max-width: 100%;
    min-width: 0;
    box-sizing: border-box;
    overflow: hidden;
  }
}
```

## 3. CSS для overlay та dropdown

### Overlay (затемнення фону)

```230:257:static/css/header.css
.burger-menu__overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 999;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  opacity: 0;
  visibility: hidden;
  transition: opacity var(--transition-normal), visibility var(--transition-normal);

  /* iOS Safari fix: hardware acceleration */
  -webkit-transform: translateZ(0);
  transform: translateZ(0);
  will-change: opacity, visibility;
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
}
```

### Dropdown меню

```260:308:static/css/header.css
.burger-menu__dropdown {
  position: fixed;
  bottom: 0;
  left: 36px;
  right: 28px;
  z-index: 1000;
  background: var(--color-gray-light);
  border-radius: var(--radius-lg);
  padding: 10px;
  visibility: hidden;
  opacity: 0;
  pointer-events: none;
  transition: transform var(--transition-normal),
              opacity var(--transition-normal),
              visibility var(--transition-normal);
  max-height: 80vh;
  overflow-y: auto;
  
  /* iOS Safari fix: hardware acceleration */
  -webkit-transform: translateY(100%) translateZ(0);
  transform: translateY(100%) translateZ(0);
  -webkit-overflow-scrolling: touch;
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
  will-change: transform, opacity, visibility;
}

.burger-menu__dropdown[aria-hidden="false"] {
  visibility: visible;
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
  -webkit-transform: translateY(0) translateZ(0);
}
```

### iOS специфічні фікси для dropdown

```317:353:static/css/header.css
@supports (-webkit-touch-callout: none) {
  .burger-menu__dropdown {
    max-height: 80dvh;
    bottom: 0;
    bottom: max(0px, env(safe-area-inset-bottom, 0px));
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
  }
  
  @media (width <= 767px) {
    .burger-menu__dropdown {
      bottom: max(90px, calc(90px + env(safe-area-inset-bottom, 0px)));
      max-height: calc(100dvh - 90px - env(safe-area-inset-bottom, 0px) - env(safe-area-inset-top, 0px));
      max-height: calc(80vh - 90px);
      -webkit-overflow-scrolling: touch;
    }
  }
}
```

## 4. JavaScript логіка блокування скролу

### Відкриття меню (блокуює скрол body)

```71:116:static/js/burger-menu.js
open() {
  // Зберігати позицію ПЕРЕД будь-якими змінами
  this.scrollPosition = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;
  
  // Зберегти в sessionStorage для надійності
  if (this.scrollPosition > 0) {
    sessionStorage.setItem('burgerMenuScrollPosition', this.scrollPosition.toString());
  }
  
  // Обчислити ширину scrollbar перед його зникненням
  const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
  
  this.isOpen = true;
  this.burger.setAttribute('aria-expanded', 'true');
  this.menu.setAttribute('aria-hidden', 'false');
  if (this.overlay) {
    this.overlay.setAttribute('aria-hidden', 'false');
  }
  
  // Використати подвійний requestAnimationFrame для iOS Safari
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      // Вимкнути smooth scroll тимчасово на html
      const html = document.documentElement;
      const originalScrollBehavior = html.style.scrollBehavior;
      html.style.scrollBehavior = 'auto';
      
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.width = '100vw';
      document.body.style.top = `-${this.scrollPosition}px`;
      document.body.style.left = '0';
      document.body.style.right = '0';
      
      // Компенсувати зникнення scrollbar
      if (scrollbarWidth > 0) {
        document.body.style.paddingRight = `${scrollbarWidth}px`;
      }
      
      // Відновити smooth scroll через невелику затримку
      setTimeout(() => {
        html.style.scrollBehavior = originalScrollBehavior || '';
      }, 50);
    });
  });
}
```

### Закриття меню (відновлює скрол)

```118:190:static/js/burger-menu.js
close() {
  this.isOpen = false;
  this.burger.setAttribute('aria-expanded', 'false');
  this.menu.setAttribute('aria-hidden', 'true');
  if (this.overlay) {
    this.overlay.setAttribute('aria-hidden', 'true');
  }
  
  // Відновити scrollPosition з sessionStorage якщо втрачено
  if (!this.scrollPosition || this.scrollPosition === 0) {
    const saved = sessionStorage.getItem('burgerMenuScrollPosition');
    if (saved) {
      this.scrollPosition = parseInt(saved, 10);
    }
  }
  
  // Відновити стилі
  const html = document.documentElement;
  const originalScrollBehavior = html.style.scrollBehavior;
  html.style.scrollBehavior = 'auto';
  
  const originalOverflowScrolling = document.body.style.webkitOverflowScrolling;
  document.body.style.webkitOverflowScrolling = 'auto';
  
  document.body.style.overflow = '';
  document.body.style.position = '';
  document.body.style.width = '';
  document.body.style.top = '';
  document.body.style.left = '';
  document.body.style.right = '';
  document.body.style.paddingRight = '';
  
  // Використати подвійний requestAnimationFrame для iOS Safari
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      setTimeout(() => {
        if (this.scrollPosition !== undefined && this.scrollPosition !== null && this.scrollPosition >= 0) {
          window.scrollTo({
            top: this.scrollPosition,
            behavior: 'auto'
          });
          
          // Для iOS Safari - додаткова перевірка
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
          if (isIOS) {
            setTimeout(() => {
              window.scrollTo({
                top: this.scrollPosition,
                behavior: 'auto'
              });
            }, 50);
          }
        }
        
        document.body.style.webkitOverflowScrolling = originalOverflowScrolling || '';
        
        setTimeout(() => {
          html.style.scrollBehavior = originalScrollBehavior || '';
        }, 100);
        
        sessionStorage.removeItem('burgerMenuScrollPosition');
      }, 20);
    });
  });
}
```

## 5. Ключові принципи реалізації

### Для основного контейнера меню:

- ✅ Використовується `position: sticky` (не `fixed`) для iOS сумісності
- ✅ `bottom: max(10px, env(safe-area-inset-bottom, 10px))` для врахування safe-area
- ✅ Hardware acceleration через `transform: translateZ(0)`
- ✅ Grid layout для розташування header та burger кнопки

### Для overlay та dropdown:

- ✅ Використовується `position: fixed` (допустимо для overlay)
- ✅ `z-index: 999` для overlay, `z-index: 1000` для dropdown
- ✅ Використання `100dvh` для iOS dynamic viewport
- ✅ Компенсація safe-area через `env(safe-area-inset-*)`

### Для блокування скролу:

- ✅ `body.style.position = 'fixed'` з `top: -${scrollPosition}px`
- ✅ Збереження позиції скролу перед блокуванням
- ✅ Компенсація зникнення scrollbar через `paddingRight`
- ✅ Подвійний `requestAnimationFrame` для iOS Safari
- ✅ Відновлення позиції після закриття меню

## 6. Файли для копіювання в інший проект

1. **CSS:** `static/css/header.css` (рядки 12-436)
2. **JavaScript:** `static/js/burger-menu.js` (повний файл)
3. **HTML структура:** `templates/main/home.html` (рядки 402-444)
4. **Додаткові утиліти (опціонально):**
   - `static/css/utils/ios-safe.css` - safe-area утиліти
   - `static/js/utils/ios-sticky.js` - утиліти для sticky позиціонування

## 7. Залежності

- CSS custom properties для кольорів та spacing (визначені в `base.css`)
- Медіа-запити: `@media (width <= 767px)` для мобільної версії
- Data-атрибути: `data-burger-toggle`, `data-burger-menu`, `data-burger-overlay`
- ARIA атрибути: `aria-expanded`, `aria-hidden`, `aria-label`

## 8. Важливі нотатки

⚠️ **НЕ використовуйте `position: fixed` для основного контейнера** - це викликає проблеми на iOS Safari. Завжди використовуйте `position: sticky`.

⚠️ **Завжди зберігайте позицію скролу** перед блокуванням body, інакше користувач втратить свою позицію на сторінці.

⚠️ **Компенсуйте зникнення scrollbar** через `paddingRight`, інакше контент змістить вправо при відкритті меню.

